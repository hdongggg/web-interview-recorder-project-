<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview System</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; }
        .screen { display: none; max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .active { display: block; }
        h1, h2 { color: #333; }
        input[type="text"] { padding: 12px; width: 70%; margin: 10px 0; border: 1px solid #ccc; border-radius: 5px; }
        #video-container { margin: 20px auto; border: 4px solid #3498db; border-radius: 8px; overflow: hidden; background: black; max-width: 640px;}
        video { width: 100%; display: block; transform: scaleX(-1); }
        button { padding: 12px 24px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.3s; }
        .btn-p { background-color: #3498db; }
        .btn-r { background-color: #e74c3c; }
        .btn-s { background-color: #333; }
        .btn-n { background-color: #2ecc71; display: none; }
        button:disabled { background-color: #ccc; }
        
        /* B·∫£ng ƒëi·ªÉm */
        .result-card { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; text-align: left; border-radius: 8px; }
        .score-badge { float: right; background: #2ecc71; color: white; padding: 5px 10px; border-radius: 15px; font-weight: bold; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>üëã AI Interview Login</h1>
        <input type="text" id="candidateName" placeholder="Enter your full name (e.g., John Doe)">
        <br><button class="btn-p" onclick="startInterview()">Start Interview</button>
    </div>

    <div id="screen-recorder" class="screen">
        <h3 id="question-title">Question 1</h3>
        <p id="question-content" style="font-size: 1.2em; min-height: 50px;">...</p>
        <div id="video-container"><video id="videoPlayer" autoplay muted></video></div>
        <div class="controls">
            <button id="startBtn" class="btn-r" onclick="startRecording()">üî¥ Record</button>
            <button id="stopBtn" class="btn-s" onclick="stopRecording()" disabled>‚èπÔ∏è Stop</button>
            <button id="nextBtn" class="btn-n" onclick="nextQuestion()">‚û°Ô∏è Next</button>
        </div>
        <p id="status">Ready...</p>
    </div>

    <div id="screen-result" class="screen">
        <h1 id="result-title">‚è≥ Analyzing your answers...</h1>
        <div id="loading-spinner" class="loader"></div>
        <p id="result-message">Please wait while our AI grades your interview.<br>Processed: <span id="processed-count">0</span>/5</p>
        
        <div id="final-score-area" style="display:none;">
            <h2 style="color: #2ecc71; font-size: 3em; margin: 10px 0;" id="avg-score">0.0</h2>
            <p>Average Score</p>
            <div id="details-list" style="margin-top: 20px;"></div>
            <button class="btn-p" onclick="location.reload()">Back to Home</button>
        </div>
    </div>

    <script>
        const QUESTIONS = [
            "Please briefly introduce yourself.",
            "What are your greatest strengths and weaknesses?",
            "Why do you want to apply for this position?",
            "Describe a challenge you faced at work and how you overcame it?",
            "What are your salary expectations?"
        ];
        let curIdx = 0;
        let cName = "";
        let mediaRecorder;
        let chunks = [];
        let stream;
        let pollInterval;

        async function startInterview() {
            const inp = document.getElementById('candidateName');
            if (!inp.value.trim()) return alert("Enter name!");
            cName = inp.value.trim().replace(/[^a-zA-Z0-9]/g, '_');
            
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-recorder').classList.add('active');
            await setupCamera();
            loadQ(0);
        }

        function loadQ(idx) {
            document.getElementById('question-title').innerText = `Question ${idx + 1}/${QUESTIONS.length}`;
            document.getElementById('question-content').innerText = QUESTIONS[idx];
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('status').innerText = "Ready...";
        }

        function nextQuestion() {
            curIdx++;
            if (curIdx < QUESTIONS.length) {
                loadQ(curIdx);
            } else {
                stopCamera();
                showResultScreen();
            }
        }

        // --- CAMERA ---
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById('videoPlayer').srcObject = stream;
            } catch { alert("Camera Error"); }
        }
        function stopCamera() { if(stream) stream.getTracks().forEach(t => t.stop()); }

        function startRecording() {
            chunks = [];
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            mediaRecorder.ondataavailable = e => { if (e.data.size > 0) chunks.push(e.data); };
            mediaRecorder.onstop = uploadVideo;
            mediaRecorder.start();
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').innerText = "üî¥ Recording...";
        }
        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').innerText = "‚è≥ Uploading (Background processing)...";
        }

        async function uploadVideo() {
            const blob = new Blob(chunks, { type: 'video/webm' });
            const fname = `${cName}_Question_${curIdx + 1}.webm`;
            const fd = new FormData();
            fd.append('file', blob, fname);

            try {
                // Upload v√† server s·∫Ω tr·∫£ v·ªÅ ngay l·∫≠p t·ª©c (kh√¥ng ƒë·ª£i AI)
                const res = await fetch('/api/upload', { method: 'POST', body: fd });
                if (res.ok) {
                    document.getElementById('status').innerText = "‚úÖ Uploaded! AI is grading in background.";
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('nextBtn').style.display = 'inline-block';
                }
            } catch { alert("Upload Failed"); }
        }

        // --- POLLING RESULTS ---
        function showResultScreen() {
            document.getElementById('screen-recorder').classList.remove('active');
            document.getElementById('screen-result').classList.add('active');
            
            // B·∫Øt ƒë·∫ßu h·ªèi server m·ªói 3 gi√¢y
            pollInterval = setInterval(checkResults, 3000);
        }

        async function checkResults() {
            try {
                const res = await fetch(`/api/results/${cName}`);
                const data = await res.json();
                
                document.getElementById('processed-count').innerText = data.count;

                if (data.completed) {
                    clearInterval(pollInterval); // D·ª´ng h·ªèi
                    renderFinalResults(data);
                }
            } catch (e) { console.error(e); }
        }

        function renderFinalResults(data) {
            document.getElementById('loading-spinner').style.display = 'none';
            document.getElementById('result-title').innerText = "üéâ Evaluation Complete!";
            document.getElementById('result-message').style.display = 'none';
            document.getElementById('final-score-area').style.display = 'block';
            
            document.getElementById('avg-score').innerText = data.avg_score;
            
            const list = document.getElementById('details-list');
            list.innerHTML = "";
            
            data.details.forEach(item => {
                list.innerHTML += `
                    <div class="result-card">
                        <span class="score-badge">${item.score}/10</span>
                        <strong>${item.question}</strong><br>
                        <em style="color:#666; font-size:0.9em">"${item.comment}"</em>
                        <details style="margin-top:5px; color:#888;">
                            <summary>Transcript</summary>
                            <small>${item.transcript}</small>
                        </details>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>
