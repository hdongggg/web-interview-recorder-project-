<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; }
        .screen { display: none; max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .active { display: block; }
        
        #video-container { margin: 20px auto; border: 4px solid #3498db; border-radius: 8px; overflow: hidden; background: black; max-width: 640px;}
        video { width: 100%; display: block; transform: scaleX(-1); }
        
        button { padding: 12px 24px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.3s; }
        .btn-blue { background-color: #3498db; }
        .btn-red { background-color: #e74c3c; }
        .btn-dark { background-color: #333; }
        .btn-green { background-color: #2ecc71; display: none; } 
        .btn-orange { background-color: #f39c12; display: none; }
        .btn-purple { background-color: #9b59b6; display: none; } /* N√∫t Finish m√†u t√≠m */
        
        button:disabled { background-color: #ccc; }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>üëã AI Interview Login</h1>
        <input type="text" id="candidateName" placeholder="Enter full name" style="padding:10px; width:70%;">
        <br><button class="btn-blue" onclick="startInterview()">Start Interview</button>
    </div>

    <div id="screen-recorder" class="screen">
        <h3 id="question-title">Question 1</h3>
        <p id="question-content" style="font-size: 1.2em; font-weight: 500;">...</p>
        
        <div id="video-container"><video id="videoPlayer" autoplay muted></video></div>
        
        <div class="controls">
            <button id="startBtn" class="btn-red" onclick="startRecording()">üî¥ Record</button>
            <button id="stopBtn" class="btn-dark" onclick="stopRecording()" disabled>‚èπÔ∏è Stop & Submit</button>
            
            <button id="reRecordBtn" class="btn-orange" onclick="reRecord()">üîÑ Re-record</button>
            
            <button id="nextBtn" class="btn-green" onclick="nextQuestion()">‚û°Ô∏è Next Question</button>
            
            <button id="finishBtn" class="btn-purple" onclick="finishInterview()">‚ú® Finish Interview</button>
        </div>
        <p id="status">Ready...</p>
    </div>

    <div id="screen-finish" class="screen">
        <h1 style="color: green; font-size: 3em;">üéâ Congratulations!</h1>
        <h2>You have completed the interview.</h2>
        <p>Your answers have been submitted. The AI is grading your performance.</p>
        <button class="btn-blue" onclick="location.reload()">Back to Home</button>
    </div>

    <script>
        const QUESTIONS = [
            "Please briefly introduce yourself.",
            "What are your greatest strengths and weaknesses?",
            "Why do you want to apply for this position?",
            "Describe a challenge you faced at work and how you overcame it?",
            "What are your salary expectations?"
        ];
        let curIdx = 0;
        let cName = "";
        let mediaRecorder, chunks = [], stream;

        async function startInterview() {
            const inp = document.getElementById('candidateName');
            if(!inp.value.trim()) return alert("Enter name!");
            cName = inp.value.trim().replace(/[^a-zA-Z0-9]/g, '_');
            
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-recorder').classList.add('active');
            await setupCamera();
            loadQ(0);
        }

        function loadQ(idx) {
            document.getElementById('question-title').innerText = `Question ${idx+1}/${QUESTIONS.length}`;
            document.getElementById('question-content').innerText = QUESTIONS[idx];
            
            // ·∫®n h·∫øt c√°c n√∫t ƒëi·ªÅu h∆∞·ªõng ƒë·ªÉ reset tr·∫°ng th√°i
            document.getElementById('startBtn').style.display = 'inline-block';
            document.getElementById('startBtn').disabled = false;
            document.getElementById('stopBtn').style.display = 'inline-block';
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('nextBtn').style.display = 'none';
            document.getElementById('reRecordBtn').style.display = 'none';
            document.getElementById('finishBtn').style.display = 'none';

            document.getElementById('status').innerText = "Ready...";
        }

        function reRecord() { loadQ(curIdx); }

        function nextQuestion() {
            curIdx++;
            loadQ(curIdx);
        }

        // H√†m chuy·ªÉn sang m√†n h√¨nh ch√∫c m·ª´ng
        function finishInterview() {
            stopCamera();
            document.getElementById('screen-recorder').classList.remove('active');
            document.getElementById('screen-finish').classList.add('active');
        }

        // --- CAMERA & UPLOAD ---
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('videoPlayer').srcObject = stream;
            } catch { alert("Camera Error"); }
        }
        function stopCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); }

        function startRecording() {
            chunks = [];
            // Gi·∫£m bitrate ƒë·ªÉ file nh·∫π h∆°n, upload nhanh h∆°n
            const options = { mimeType: 'video/webm;codecs=vp8,opus', videoBitsPerSecond: 250000 };
            try { mediaRecorder = new MediaRecorder(stream, options); } 
            catch { mediaRecorder = new MediaRecorder(stream); }

            mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            mediaRecorder.onstop = uploadVideo;
            mediaRecorder.start();
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('stopBtn').disabled = false;
            document.getElementById('status').innerText = "üî¥ Recording...";
        }
        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').innerText = "‚è≥ Uploading...";
        }

        async function uploadVideo() {
            const blob = new Blob(chunks, {type:'video/webm'});
            const fname = `${cName}_Question_${curIdx+1}.webm`;
            const fd = new FormData();
            fd.append('file', blob, fname);

            try {
                const res = await fetch('/api/upload', {method:'POST', body:fd});
                if(res.ok) {
                    document.getElementById('status').innerText = "‚úÖ Submitted! AI is grading...";
                    
                    document.getElementById('startBtn').style.display = 'none';
                    document.getElementById('stopBtn').style.display = 'none';
                    document.getElementById('reRecordBtn').style.display = 'inline-block';

                    // LOGIC QUAN TR·ªåNG: Ki·ªÉm tra xem ƒë√£ ƒë·∫øn c√¢u cu·ªëi ch∆∞a
                    if (curIdx === QUESTIONS.length - 1) {
                        // N·∫øu l√† c√¢u 5: Hi·ªán n√∫t Finish
                        document.getElementById('finishBtn').style.display = 'inline-block';
                    } else {
                        // N·∫øu ch∆∞a ph·∫£i c√¢u 5: Hi·ªán n√∫t Next
                        document.getElementById('nextBtn').style.display = 'inline-block';
                    }
                }
            } catch { alert("Upload Failed"); }
        }
    </script>
</body>
</html>
