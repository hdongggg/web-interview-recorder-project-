<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Video Recorder</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        #videoPlayer { border: 2px solid #3498db; margin: 20px auto; display: block; }
        .controls button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
        #startBtn { background-color: #2ecc71; color: white; }
        #stopBtn { background-color: #e74c3c; color: white; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; }
        #resultContainer { margin-top: 30px; padding: 10px; border-top: 1px solid #ccc; }
    </style>
</head>
<body>

    <h1>Webcam Recorder</h1>
    <video id="videoPlayer" width="640" height="480" autoplay muted></video>

    <div class="controls">
        <button id="startBtn" disabled>ğŸ”´ Báº¯t Äáº§u Ghi</button>
        <button id="stopBtn" disabled>â¹ï¸ Dá»«ng Ghi & Táº£i LÃªn</button>
    </div>

    <p id="status">Äang táº£i...</p>

    <div id="resultContainer"></div>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');
        const resultContainer = document.getElementById('resultContainer'); // Láº¥y pháº§n tá»­ má»›i

        // CHá»ˆNH Sá»¬A Äá»ŠA CHá»ˆ NÃ€Y KHI TRIá»‚N KHAI ONLINE
        const UPLOAD_URL = 'https://web-interview-recorder-project.onrender.com/api/upload';

        let mediaRecorder;
        let recordedChunks = [];
        let stream;

        // 1. Khá»Ÿi táº¡o Camera
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoPlayer.srcObject = stream;
                statusEl.textContent = 'âœ… Camera sáºµn sÃ ng.';
                startBtn.disabled = false;
            } catch (error) {
                statusEl.textContent = `âŒ Lá»—i: KhÃ´ng thá»ƒ truy cáº­p camera. Vui lÃ²ng cháº¡y trÃªn localhost hoáº·c HTTPS.`;
            }
        }

        // 2. Báº¯t Ä‘áº§u Ghi
        startBtn.onclick = () => {
            if (!stream) return;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            recordedChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };

            mediaRecorder.start();
            statusEl.textContent = 'ğŸ”´ Äang ghi hÃ¬nh...';
            startBtn.disabled = true;
            stopBtn.disabled = false;
            resultContainer.innerHTML = ''; // XÃ³a káº¿t quáº£ cÅ© khi báº¯t Ä‘áº§u ghi
        };

        // 3. Dá»«ng Ghi & Táº£i lÃªn
        stopBtn.onclick = () => {
            mediaRecorder.stop();
            statusEl.textContent = 'Äang dá»«ng vÃ  chuáº©n bá»‹ táº£i lÃªn...';
            startBtn.disabled = true;
            stopBtn.disabled = true;

            mediaRecorder.onstop = () => {
                const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                const filename = `response_video_${Date.now()}.webm`;
                uploadVideo(videoBlob, filename);

                // Dá»«ng camera
                stream.getTracks().forEach(track => track.stop());
                videoPlayer.srcObject = null;
            };
        };

        // 4. HÃ m Táº£i lÃªn Server
        async function uploadVideo(videoBlob, filename) {
            const formData = new FormData();
            formData.append('file', videoBlob, filename);

            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    const videoUrl = result.url; // Láº¥y Ä‘Æ°á»ng dáº«n video tá»« server (vÃ­ dá»¥: /uploads/ten_file.webm)

                    statusEl.textContent = `âœ… Táº£i lÃªn thÃ nh cÃ´ng!`;

                    // Hiá»ƒn thá»‹ video Ä‘Ã£ ghi vÃ  link xem
                    resultContainer.innerHTML =
                        `<h3>Video Ä‘Ã£ ghi</h3>
                         <video src="${videoUrl}" width="400" height="300" controls></video>
                         <p>ÄÆ°á»ng dáº«n cÃ´ng khai: <a href="${videoUrl}" target="_blank">${videoUrl}</a></p>`;

                } else {
                    statusEl.textContent = `âŒ Lá»—i: ${result.detail || response.statusText}`;
                    resultContainer.innerHTML = `<p>Lá»—i táº£i lÃªn. Vui lÃ²ng kiá»ƒm tra Log Render.</p>`;
                }
            } catch (error) {
                statusEl.textContent = `âŒ Lá»—i máº¡ng: KhÃ´ng káº¿t ná»‘i Ä‘Æ°á»£c tá»›i server.`;
                resultContainer.innerHTML = `<p>Lá»—i máº¡ng. Vui lÃ²ng kiá»ƒm tra server online Ä‘Ã£ cháº¡y chÆ°a.</p>`;
            } finally {
                startBtn.disabled = false;
                stopBtn.disabled = true;
                setupCamera();
            }
        }

        setupCamera();
    </script>
</body>
</html>