<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Video Recorder</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        #videoPlayer { border: 2px solid #3498db; margin: 20px auto; display: block; }
        .controls button { padding: 10px 20px; margin: 5px; cursor: pointer; border: none; border-radius: 5px; }
        #startBtn { background-color: #2ecc71; color: white; }
        #stopBtn { background-color: #e74c3c; color: white; }
        button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

    <h1>Webcam Recorder</h1>
    <video id="videoPlayer" width="640" height="480" autoplay muted></video>

    <div class="controls">
        <button id="startBtn" disabled>üî¥ B·∫Øt ƒê·∫ßu Ghi</button>
        <button id="stopBtn" disabled>‚èπÔ∏è D·ª´ng Ghi & T·∫£i L√™n</button>
    </div>

    <p id="status">ƒêang t·∫£i...</p>

    <script>
        const videoPlayer = document.getElementById('videoPlayer');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const statusEl = document.getElementById('status');

        // CH·ªàNH S·ª¨A ƒê·ªäA CH·ªà N√ÄY KHI TRI·ªÇN KHAI ONLINE
        const UPLOAD_URL = 'http://127.0.0.1:8000/api/upload';

        let mediaRecorder;
        let recordedChunks = [];
        let stream;

        // 1. Kh·ªüi t·∫°o Camera
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                videoPlayer.srcObject = stream;
                statusEl.textContent = '‚úÖ Camera s·∫µn s√†ng.';
                startBtn.disabled = false;
            } catch (error) {
                statusEl.textContent = `‚ùå L·ªói: Kh√¥ng th·ªÉ truy c·∫≠p camera. Vui l√≤ng ch·∫°y tr√™n localhost ho·∫∑c HTTPS.`;
            }
        }

        // 2. B·∫Øt ƒë·∫ßu Ghi
        startBtn.onclick = () => {
            if (!stream) return;
            mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });
            recordedChunks = [];

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) recordedChunks.push(event.data);
            };

            mediaRecorder.start();
            statusEl.textContent = 'üî¥ ƒêang ghi h√¨nh...';
            startBtn.disabled = true;
            stopBtn.disabled = false;
        };

        // 3. D·ª´ng Ghi & T·∫£i l√™n
        stopBtn.onclick = () => {
            mediaRecorder.stop();
            statusEl.textContent = 'ƒêang d·ª´ng v√† chu·∫©n b·ªã t·∫£i l√™n...';
            startBtn.disabled = true;
            stopBtn.disabled = true;

            mediaRecorder.onstop = () => {
                const videoBlob = new Blob(recordedChunks, { type: 'video/webm' });
                const filename = `response_video_${Date.now()}.webm`;
                uploadVideo(videoBlob, filename);

                // D·ª´ng camera
                stream.getTracks().forEach(track => track.stop());
                videoPlayer.srcObject = null;
            };
        };

        // 4. H√†m T·∫£i l√™n Server
        async function uploadVideo(videoBlob, filename) {
            const formData = new FormData();
            formData.append('file', videoBlob, filename); // T√™n tr∆∞·ªùng 'file' ph·∫£i kh·ªõp v·ªõi Back-end

            try {
                const response = await fetch(UPLOAD_URL, {
                    method: 'POST',
                    body: formData,
                });

                const result = await response.json();

                if (response.ok) {
                    statusEl.textContent = `‚úÖ T·∫£i l√™n th√†nh c√¥ng! File t·∫°i: ${result.url}`;
                } else {
                    statusEl.textContent = `‚ùå L·ªói: ${result.detail || response.statusText}`;
                }
            } catch (error) {
                statusEl.textContent = `‚ùå L·ªói m·∫°ng: Kh√¥ng k·∫øt n·ªëi ƒë∆∞·ª£c t·ªõi server.`;
            } finally {
                startBtn.disabled = false; // Cho ph√©p ghi ti·∫øp
                stopBtn.disabled = true;
                setupCamera();
            }
        }

        setupCamera();
    </script>
</body>
</html>