<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Interview</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; text-align: center; padding: 20px; background-color: #f0f2f5; }
        .screen { display: none; max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .active { display: block; }
        
        #video-container { margin: 20px auto; border: 4px solid #3498db; border-radius: 8px; overflow: hidden; background: black; max-width: 640px;}
        video { width: 100%; display: block; transform: scaleX(-1); }
        
        button { padding: 12px 24px; margin: 10px; cursor: pointer; border: none; border-radius: 5px; font-weight: bold; color: white; transition: 0.3s; }
        .btn-blue { background-color: #3498db; }
        .btn-red { background-color: #e74c3c; }
        .btn-dark { background-color: #333; }
        
        /* 2 n√∫t quan tr·ªçng */
        .btn-next { background-color: #2ecc71; display: none; } 
        .btn-orange { background-color: #f39c12; display: none; } /* N√∫t Re-record */
        
        button:disabled { background-color: #ccc; }
        
        /* K·∫øt qu·∫£ */
        .result-card { background: #f8f9fa; border: 1px solid #ddd; padding: 15px; margin-bottom: 10px; text-align: left; border-radius: 8px; }
        .score-badge { float: right; background: #2ecc71; color: white; padding: 5px 10px; border-radius: 15px; }
        .loader { border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="screen-login" class="screen active">
        <h1>üëã AI Interview Login</h1>
        <input type="text" id="candidateName" placeholder="Enter full name" style="padding:10px; width:70%;">
        <br><button class="btn-blue" onclick="startInterview()">Start Interview</button>
    </div>

    <div id="screen-recorder" class="screen">
        <h3 id="question-title">Question 1</h3>
        <p id="question-content" style="font-size: 1.2em; font-weight: 500;">...</p>
        
        <div id="video-container"><video id="videoPlayer" autoplay muted></video></div>
        
        <div class="controls">
            <button id="startBtn" class="btn-red" onclick="startRecording()">üî¥ Record</button>
            <button id="stopBtn" class="btn-dark" onclick="stopRecording()" disabled>‚èπÔ∏è Stop & Submit</button>
            
            <button id="nextBtn" class="btn-next" onclick="nextQuestion()">‚û°Ô∏è Next Question</button>
            <button id="reRecordBtn" class="btn-orange" onclick="reRecord()">üîÑ Re-record</button>
        </div>
        <p id="status">Ready...</p>
    </div>

    <div id="screen-result" class="screen">
        <h1>‚è≥ Grading in progress...</h1>
        <div id="loading-spinner" class="loader"></div>
        <p id="status-msg">AI is analyzing your answers. Please wait.</p>
        
        <div id="final-result" style="display:none;">
            <h2 id="avg-score" style="font-size:3em; color:#2ecc71; margin:10px 0;">0.0</h2>
            <p>Average Score</p>
            <div id="details-list"></div>
            <button class="btn-blue" onclick="location.reload()">Finish</button>
        </div>
    </div>

    <script>
        const QUESTIONS = [
            "Please briefly introduce yourself.",
            "What are your greatest strengths and weaknesses?",
            "Why do you want to apply for this position?",
            "Describe a challenge you faced at work and how you overcame it?",
            "What are your salary expectations?"
        ];
        let curIdx = 0;
        let cName = "";
        let mediaRecorder, chunks = [], stream, pollInterval;

        async function startInterview() {
            const inp = document.getElementById('candidateName');
            if(!inp.value.trim()) return alert("Enter name!");
            cName = inp.value.trim().replace(/[^a-zA-Z0-9]/g, '_');
            
            document.getElementById('screen-login').classList.remove('active');
            document.getElementById('screen-recorder').classList.add('active');
            await setupCamera();
            loadQ(0);
        }

        function loadQ(idx) {
            document.getElementById('question-title').innerText = `Question ${idx+1}/${QUESTIONS.length}`;
            document.getElementById('question-content').innerText = QUESTIONS[idx];
            
            // Reset n√∫t v·ªÅ tr·∫°ng th√°i ban ƒë·∫ßu
            toggleButtons(true, false, false, false); 
            document.getElementById('status').innerText = "Ready...";
        }

        // --- T√çNH NƒÇNG RE-RECORD ---
        function reRecord() {
            // Ch·ªâ c·∫ßn load l·∫°i c√¢u h·ªèi hi·ªán t·∫°i, cho ph√©p quay ƒë√® l√™n file c≈©
            loadQ(curIdx);
        }

        function nextQuestion() {
            curIdx++;
            if (curIdx < QUESTIONS.length) {
                loadQ(curIdx);
            } else {
                stopCamera();
                showWaitingScreen();
            }
        }

        function toggleButtons(start, stop, next, rerecord) {
            const bStart = document.getElementById('startBtn');
            const bStop = document.getElementById('stopBtn');
            const bNext = document.getElementById('nextBtn');
            const bRe = document.getElementById('reRecordBtn');
            
            bStart.style.display = 'inline-block'; bStart.disabled = !start;
            bStop.style.display = 'inline-block'; bStop.disabled = !stop;
            bNext.style.display = next ? 'inline-block' : 'none';
            bRe.style.display = rerecord ? 'inline-block' : 'none';
        }

        // --- CAMERA ---
        async function setupCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                document.getElementById('videoPlayer').srcObject = stream;
            } catch { alert("Camera Error"); }
        }
        function stopCamera() { if(stream) stream.getTracks().forEach(t=>t.stop()); }

        function startRecording() {
            chunks = [];
            mediaRecorder = new MediaRecorder(stream, {mimeType:'video/webm'});
            mediaRecorder.ondataavailable = e => { if(e.data.size>0) chunks.push(e.data); };
            mediaRecorder.onstop = uploadVideo;
            mediaRecorder.start();
            toggleButtons(false, true, false, false);
            document.getElementById('status').innerText = "üî¥ Recording...";
        }
        function stopRecording() {
            mediaRecorder.stop();
            document.getElementById('stopBtn').disabled = true;
            document.getElementById('status').innerText = "‚è≥ Uploading...";
        }

        async function uploadVideo() {
            const blob = new Blob(chunks, {type:'video/webm'});
            // T√™n file gi·ªØ nguy√™n logic (kh√¥ng timestamp) ƒë·ªÉ h·ªó tr·ª£ Re-record ghi ƒë√®
            const fname = `${cName}_Question_${curIdx+1}.webm`;
            const fd = new FormData();
            fd.append('file', blob, fname);

            try {
                const res = await fetch('/api/upload', {method:'POST', body:fd});
                if(res.ok) {
                    document.getElementById('status').innerText = "‚úÖ Uploaded! AI is grading...";
                    // HI·ªÜN N√öT NEXT V√Ä RE-RECORD
                    toggleButtons(false, false, true, true);
                }
            } catch { alert("Upload Failed"); }
        }

        // --- WAITING & RESULTS ---
        function showWaitingScreen() {
            document.getElementById('screen-recorder').classList.remove('active');
            document.getElementById('screen-result').classList.add('active');
            pollInterval = setInterval(checkResults, 3000); // H·ªèi server m·ªói 3s
        }

        async function checkResults() {
            try {
                const res = await fetch(`/api/results/${cName}`);
                const data = await res.json();
                
                // N·∫øu ƒë√£ ch·∫•m xong (ƒë·ªß 5 c√¢u)
                if (data.completed) {
                    clearInterval(pollInterval);
                    
                    document.getElementById('loading-spinner').style.display = 'none';
                    document.getElementById('status-msg').style.display = 'none';
                    document.getElementById('final-result').style.display = 'block';
                    
                    document.getElementById('avg-score').innerText = data.avg_score;
                    const list = document.getElementById('details-list');
                    list.innerHTML = "";
                    
                    data.details.forEach(item => {
                        list.innerHTML += `
                            <div class="result-card">
                                <span class="score-badge">${item.score}/10</span>
                                <strong>${item.question}</strong><br>
                                <small style="color:#555">"${item.comment}"</small>
                            </div>
                        `;
                    });
                } else {
                    document.getElementById('status-msg').innerText = `AI is grading... Processed: ${data.count}/5`;
                }
            } catch (e) { console.error(e); }
        }
    </script>
</body>
</html>
