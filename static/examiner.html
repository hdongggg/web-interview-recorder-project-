<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examiner Portal</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; }
        h1 { text-align: center; color: #333; }
        
        /* B·∫£ng */
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; table-layout: fixed; }
        th, td { border-bottom: 1px solid #ddd; padding: 15px; text-align: left; vertical-align: top; word-wrap: break-word; }
        th { background-color: #007bff; color: white; font-weight: 600; }
        
        /* Badges */
        .badge-pending { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 0.85em; display: inline-block; margin-bottom: 5px;}
        .badge-score { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; padding: 4px 10px; border-radius: 12px; font-weight: bold; font-size: 1.1em; display: inline-block; margin-bottom: 5px;}
        
        /* Buttons */
        .btn { padding: 6px 12px; margin: 2px; border-radius: 4px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 12px; text-decoration: none; display: inline-block; transition: 0.2s;}
        .btn:hover { opacity: 0.8; }
        .btn-watch { background: #17a2b8; }
        .btn-stt { background: #6f42c1; } 
        .btn-del { background: #dc3545; }
        .btn-report { background: #28a745; width: 100%; margin-top: 5px; } 
        .btn-download-small { background-color: #28a745; font-size: 11px; padding: 3px 8px; }

        /* Transcript */
        .transcript-box { margin-top: 10px; padding: 10px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 4px; font-size: 13px; color: #333; display: none; }
        .transcript-content { max-height: 150px; overflow-y: auto; white-space: pre-wrap; margin-bottom: 5px; }
        
        /* Video Preview Modal */
        #preview-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .preview-content { background: black; padding: 10px; border-radius: 8px; position: relative; max-width: 90%; max-height: 90%; }
    </style>
</head>
<body>

    <h1>üìã Interview Progress & AI Scoring</h1>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="color: #666; font-size: 0.9em;">Auto-refreshing every 5s...</span>
        <div>
            <button class="btn btn-del" onclick="nuke()">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-watch" onclick="loadVideos()">üîÑ Refresh Now</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 25%">Candidate / File</th>
                <th style="width: 15%">Time</th>
                <th style="width: 40%">AI Analysis</th> <th style="width: 20%">Actions</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>

    <div id="preview-modal" onclick="closePreview()">
        <div class="preview-content" onclick="event.stopPropagation()">
            <div id="video-place"></div>
            <button class="btn btn-del" style="width: 100%; margin-top: 10px;" onclick="closePreview()">Close</button>
        </div>
    </div>

    <script>
        // H√†m t·∫£i d·ªØ li·ªáu
        async function loadVideos() {
            try {
                const res = await fetch('/api/videos');
                const videos = await res.json();
                const el = document.getElementById('list');
                el.innerHTML = '';

                if (videos.length === 0) {
                    el.innerHTML = '<tr><td colspan="4" style="text-align:center; padding:20px; color:#777;">No videos found. Waiting for candidates...</td></tr>';
                    return;
                }

                videos.forEach(v => {
                    // [QUAN TR·ªåNG] L·∫•y t√™n file th·ª±c t·∫ø t·ª´ URL ƒë·ªÉ d√πng cho c√°c h√†nh ƒë·ªông (X√≥a/D·ªãch)
                    // URL: /uploads/1709..._NguyenVanA_Question_1.webm -> Filename: 1709..._NguyenVanA_Question_1.webm
                    const realFilename = v.url.split('/').pop();
                    
                    // Tr√≠ch xu·∫•t t√™n ·ª©ng vi√™n cho n√∫t Report
                    // Regex t√¨m chu·ªói gi·ªØa d·∫•u _ ƒë·∫ßu ti√™n v√† _Question_
                    // V√≠ d·ª•: 1234_NguyenVanA_Question_1 -> NguyenVanA
                    let candidateNameRaw = "";
                    const nameMatch = realFilename.match(/_\d+_([a-zA-Z0-9_]+)_Question_/);
                    if (nameMatch && nameMatch[1]) {
                        candidateNameRaw = nameMatch[1];
                    } else {
                        // Fallback n·∫øu kh√¥ng kh·ªõp format m·ªõi
                        candidateNameRaw = realFilename.split('_Question_')[0];
                    }

                    // Logic hi·ªÉn th·ªã ƒëi·ªÉm
                    let analysisContent = "";
                    if (v.grading_status === 'done') {
                        // ƒê√£ ch·∫•m xong: Hi·ªán ƒëi·ªÉm + Comment + Transcript c√≥ s·∫µn
                        let colorStyle = v.score >= 8 ? "background:#d4edda; color:#155724; border-color:#c3e6cb;" : 
                                         (v.score >= 5 ? "background:#fff3cd; color:#856404; border-color:#ffeeba;" : "background:#f8d7da; color:#721c24; border-color:#f5c6cb;");
                        
                        // Transcript r√∫t g·ªçn
                        let shortTrans = v.transcript_preview ? v.transcript_preview.replace(/^\[Score.*?\]\s*/, '') : "No transcript";
                        
                        analysisContent = `
                            <span class="badge-score" style="${colorStyle}">${v.score}/10</span>
                            <br><small style="font-style:italic;">"${v.comment}"</small>
                            <details style="margin-top:5px; cursor:pointer;">
                                <summary style="font-size:11px; color:#007bff;">Show Transcript</summary>
                                <div style="font-size:12px; margin-top:5px; white-space: pre-wrap; max-height:100px; overflow-y:auto;">${shortTrans}</div>
                            </details>
                        `;
                    } else {
                        // ƒêang ch·∫•m
                        analysisContent = `<span class="badge-pending">‚è≥ Grading...</span><br><small style="color:#999">AI is processing...</small>`;
                    }

                    el.innerHTML += `
                        <tr>
                            <td>
                                <strong>${v.name}</strong> <br><small style="color:#666">${v.size}</small>
                                <button class="btn btn-report" onclick="getReport('${candidateNameRaw}')">
                                    üìÑ Get Full Report
                                </button>
                            </td>
                            <td>${v.created}</td>
                            <td>${analysisContent}</td>
                            <td>
                                <button class="btn btn-watch" onclick="play('${v.url}')">üëÅÔ∏è Watch</button>
                                <button class="btn btn-del" onclick="del('${realFilename}')">üóëÔ∏è Del</button>
                                <button class="btn btn-stt" onclick="transcribeVideo('${realFilename}', this)">‚ú® Re-Check</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) { console.error("Load error:", e); }
        }

        // --- C√°c h√†m ti·ªán √≠ch ---
        async function del(filename) {
            if(!confirm('Delete this video?')) return;
            await fetch(`/api/video/${filename}`, {method:'DELETE'}); 
            loadVideos(); 
        }
        
        async function getReport(cname) {
            if(!confirm(`Generate full report for candidate: ${cname}?`)) return;
            try {
                const res = await fetch(`/api/report/${cname}`);
                if (res.status !== 200) {
                    alert("Not enough data or file mismatch. Make sure candidate has finished 5 questions.");
                    return;
                }
                const data = await res.json();
                if (data.ok) {
                    const a = document.createElement('a');
                    a.href = data.url;
                    a.download = `REPORT_${cname}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                }
            } catch(e) { alert("Error generating report"); }
        }

        // H√†m g·ªçi l·∫°i STT th·ªß c√¥ng (ph√≤ng h·ªù)
        async function transcribeVideo(filename, btn) {
            btn.innerText = "‚è≥..."; btn.disabled = true;
            try {
                await fetch(`/api/transcribe/${filename}`, {method:'POST'});
                loadVideos();
            } catch { alert("Error"); }
            btn.innerText = "‚ú® Re-Check"; btn.disabled = false;
        }

        async function nuke() {
            if(confirm('WARNING: DELETE ALL DATA?')) { 
                await fetch('/api/nuke-all-videos', {method:'DELETE'}); 
                loadVideos(); 
            }
        }

        function play(url) {
            document.getElementById('video-place').innerHTML = `<video controls autoplay src="${url}" style="max-height:400px; max-width:100%"></video>`;
            document.getElementById('preview-modal').style.display = 'flex';
        }
        
        function closePreview() {
            document.getElementById('preview-modal').style.display = 'none';
            document.getElementById('video-place').innerHTML = ''; 
        }

        loadVideos();
        setInterval(loadVideos, 5000);
    </script>
</body>
</html>
