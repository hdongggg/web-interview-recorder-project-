<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Examiner Portal</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; max-width: 1200px; margin: 0 auto; padding: 20px; background-color: #f8f9fa; }
        h1 { text-align: center; color: #333; }
        
        /* B·∫£ng */
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        th, td { border-bottom: 1px solid #ddd; padding: 15px; text-align: left; vertical-align: middle; }
        th { background-color: #007bff; color: white; }
        
        /* Tr·∫°ng th√°i ch·∫•m ƒëi·ªÉm */
        .badge-pending { 
            background: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 5px 10px; border-radius: 20px; font-weight: bold; font-size: 0.85em; 
            display: inline-block;
        }
        .badge-score { 
            background: #d4edda; color: #155724; border: 1px solid #c3e6cb;
            padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 1.1em; 
            display: inline-block;
        }
        
        /* N√∫t b·∫•m */
        .btn { padding: 6px 12px; margin: 2px; border-radius: 4px; border: none; cursor: pointer; color: white; font-weight: bold; font-size: 13px; text-decoration: none; display: inline-block; transition: 0.2s;}
        .btn:hover { opacity: 0.8; }
        .btn-watch { background: #17a2b8; }
        .btn-del { background: #dc3545; }
        
        /* Video Preview */
        #preview-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); display: none;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .preview-content {
            background: black; padding: 20px; border-radius: 8px; position: relative;
            max-width: 90%; max-height: 90%;
        }
    </style>
</head>
<body>

    <h1>üìã Interview Progress & AI Scoring</h1>
    
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <span style="color: #666;">Auto-refreshing every 5s...</span>
        <div>
            <button class="btn btn-del" onclick="nuke()">üóëÔ∏è Clear All Data</button>
            <button class="btn btn-watch" onclick="loadVideos()">üîÑ Refresh Now</button>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 30%">Candidate / File</th>
                <th style="width: 15%">Submitted Time</th>
                <th style="width: 15%">AI Score</th> 
                <th style="width: 25%">AI Comment</th>
                <th style="width: 15%">Actions</th>
            </tr>
        </thead>
        <tbody id="list"></tbody>
    </table>

    <div id="preview-modal" onclick="closePreview()">
        <div class="preview-content" onclick="event.stopPropagation()">
            <div id="video-place"></div>
            <button class="btn btn-del" style="width: 100%; margin-top: 10px;" onclick="closePreview()">Close</button>
        </div>
    </div>

    <script>
        // H√†m t·∫£i d·ªØ li·ªáu
        async function loadVideos() {
            try {
                const res = await fetch('/api/videos');
                const videos = await res.json();
                const el = document.getElementById('list');
                el.innerHTML = '';

                if (videos.length === 0) {
                    el.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#777;">No videos found. Waiting for candidates...</td></tr>';
                    return;
                }

                videos.forEach(v => {
                    // Logic hi·ªÉn th·ªã ƒëi·ªÉm s·ªë
                    let scoreDisplay = `<span class="badge-pending">‚è≥ Grading...</span>`;
                    let commentDisplay = `<span style="color:#999; font-style:italic;">Processing...</span>`;
                    
                    // N·∫øu Backend b√°o ƒë√£ ch·∫•m xong (done)
                    if (v.grading_status === 'done') {
                        // T√¥ m√†u ƒëi·ªÉm s·ªë d·ª±a tr√™n thang ƒëi·ªÉm
                        let colorStyle = "";
                        if(v.score >= 8) colorStyle = "background:#d4edda; color:#155724; border-color:#c3e6cb;"; // Xanh (Gi·ªèi)
                        else if(v.score >= 5) colorStyle = "background:#fff3cd; color:#856404; border-color:#ffeeba;"; // V√†ng (Kh√°)
                        else colorStyle = "background:#f8d7da; color:#721c24; border-color:#f5c6cb;"; // ƒê·ªè (Y·∫øu)

                        scoreDisplay = `<span class="badge-score" style="${colorStyle}">${v.score}/10</span>`;
                        commentDisplay = `<small style="color:#333">${v.comment}</small>`;
                    }

                    el.innerHTML += `
                        <tr>
                            <td>
                                <strong>${v.name}</strong><br>
                                <small style="color:#666">${v.size}</small>
                            </td>
                            <td>${v.created}</td>
                            <td>${scoreDisplay}</td>
                            <td>${commentDisplay}</td>
                            <td>
                                <button class="btn btn-watch" onclick="play('${v.url}')">üëÅÔ∏è Watch</button>
                                <button class="btn btn-del" onclick="del('${v.name}')">üóëÔ∏è</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) { console.error("Load error:", e); }
        }

        // --- C√°c h√†m ti·ªán √≠ch ---
        async function del(name) {
            if(confirm('Are you sure you want to delete this video?')) { 
                await fetch(`/api/video/${name}`, {method:'DELETE'}); 
                loadVideos(); 
            }
        }
        async function getReport(cname) {
            if(!confirm(`Generate full report for ${cname}? This requires 5 submitted questions.`)) return;
            
            try {
                // Hi·ªÉn th·ªã tr·∫°ng th√°i ch·ªù t·∫£i
                document.getElementById('list').innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:var(--primary);">‚è≥ Generating report... Please wait.</td></tr>';

                const res = await fetch(`/api/report/${cname}`);
                
                if (res.status === 404 || res.status === 400) {
                     alert("ERROR: This candidate has not completed 5 questions yet.");
                     loadVideos();
                     return;
                }
                
                const data = await res.json();
                
                if (data.ok) {
                    // T·ª± ƒë·ªông t·∫£i file v·ªÅ
                    const a = document.createElement('a');
                    a.href = data.url;
                    a.download = `REPORT_${cname}.txt`;
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                    alert(`Report saved as REPORT_${cname}.txt!`);
                    loadVideos(); // T·∫£i l·∫°i giao di·ªán sau khi xong
                } else {
                    alert("Unknown error during report generation.");
                    loadVideos();
                }
            } catch(e) { 
                alert("Critical error creating report. Check console."); 
                console.error(e);
                loadVideos();
            }
        }
        
        async function nuke() {
            if(confirm('WARNING: This will delete ALL videos and scores. Continue?')) { 
                await fetch('/api/nuke-all-videos', {method:'DELETE'}); 
                loadVideos(); 
            }
        }

        function play(url) {
            document.getElementById('video-place').innerHTML = `<video controls autoplay src="${url}" style="max-height:400px; max-width:100%"></video>`;
            document.getElementById('preview-modal').style.display = 'flex';
        }
        
        function closePreview() {
            document.getElementById('preview-modal').style.display = 'none';
            document.getElementById('video-place').innerHTML = ''; // D·ª´ng video
        }

        // Ch·∫°y l·∫ßn ƒë·∫ßu
        loadVideos();
        
        // T·ª± ƒë·ªông c·∫≠p nh·∫≠t m·ªói 5 gi√¢y (Real-time update)
        setInterval(loadVideos, 5000);
    </script>
</body>
</html>
